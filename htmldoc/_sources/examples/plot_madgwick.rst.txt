
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/plot_madgwick.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_examples_plot_madgwick.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_plot_madgwick.py:


Madgwick attitude estimator
===========================

.. GENERATED FROM PYTHON SOURCE LINES 7-9

Main libraries import
---------------------

.. GENERATED FROM PYTHON SOURCE LINES 9-21

.. code-block:: default


    import numpy as np
    from numpy import pi, sqrt

    from blocksim.Simulation import Simulation
    from blocksim.control.System import G6DOFSystem
    from blocksim.control.IMU import IMU
    from blocksim.control.SetPoint import Step
    from blocksim.control.Estimator import MadgwickFilter
    from blocksim.utils import deg, euler_to_quat









.. GENERATED FROM PYTHON SOURCE LINES 22-24

Construction of the simulation
------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 24-27

.. code-block:: default


    sim = Simulation()








.. GENERATED FROM PYTHON SOURCE LINES 28-29

Definition of a null Step function

.. GENERATED FROM PYTHON SOURCE LINES 29-34

.. code-block:: default


    ctrl = Step(name="ctrl", snames=["u%i" % i for i in range(6)], cons=np.zeros(6))

    sim.addComputer(ctrl)








.. GENERATED FROM PYTHON SOURCE LINES 35-36

Initialisation of a G6DOFSystem, rotating about the pitch axis

.. GENERATED FROM PYTHON SOURCE LINES 36-49

.. code-block:: default


    sys = G6DOFSystem("sys")

    angle_ini = -60 * np.pi / 180.0
    wangle = 10.0 * np.pi / 180.0
    x0 = np.zeros(13)
    x0[10:13] = np.array([0.0, wangle, 0.0])
    q = euler_to_quat(roll=0.0, pitch=angle_ini, yaw=pi / 2)
    x0[6:10] = q
    sys.setInitialStateForOutput(x0, "state")

    sim.addComputer(sys)








.. GENERATED FROM PYTHON SOURCE LINES 50-51

Initialisation of a biased and noisy IMU

.. GENERATED FROM PYTHON SOURCE LINES 51-63

.. code-block:: default


    imu = IMU(name="imu")
    cov = np.diag(3 * [np.pi / 180] + 3 * [1e-3 * 9.81] + 3 * [1.0e-6])
    imu.setCovariance(cov)
    moy = np.zeros(9)
    moy[0] = 0.5 * np.pi / 180
    moy[1] = -1.0 * np.pi / 180
    moy[2] = 1.5 * np.pi / 180
    imu.setMean(moy)

    sim.addComputer(imu)








.. GENERATED FROM PYTHON SOURCE LINES 64-65

Initialisation of the Madgwick attitude estimator

.. GENERATED FROM PYTHON SOURCE LINES 65-73

.. code-block:: default


    est = MadgwickFilter("madg", beta=2.0)
    est.setMagnetometerCalibration(offset=np.arange(3), softiron_matrix=np.eye(3) / 2)
    b, m = est.getMagnetometerCalibration()
    est.setMagnetometerCalibration(offset=np.zeros(3), softiron_matrix=np.eye(3))

    sim.addComputer(est)








.. GENERATED FROM PYTHON SOURCE LINES 74-76

Simulation
----------

.. GENERATED FROM PYTHON SOURCE LINES 76-108

.. code-block:: default


    from blocksim.graphics import plotVerif
    from matplotlib import pyplot as plt

    sim.connect("ctrl.setpoint", "sys.command")
    sim.connect("sys.state", "imu.state")
    sim.connect("imu.measurement", "madg.measurement")

    tfin = -2 * angle_ini / wangle
    tps = np.arange(0.0, tfin, 1e-2)
    w = angle_ini + tps * wangle

    sim.simulate(tps, progress_bar=False)
    log = sim.getLogger()

    plotVerif(
        log,
        "Figure 1",
        [
            {"var": "deg(madg_euler_roll)", "label": "FilteredRoll"},
            {"var": "deg(madg_euler_pitch)", "label": "FilteredPitch"},
            {"var": "deg(madg_euler_yaw)", "label": "FilteredYaw"},
            {
                "var": deg(w),
                "label": "Simu",
                "color": "black",
                "linestyle": "--",
            },
        ],
    )

    plt.show()



.. image-sg:: /examples/images/sphx_glr_plot_madgwick_001.png
   :alt: Axe 1
   :srcset: /examples/images/sphx_glr_plot_madgwick_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  1.579 seconds)


.. _sphx_glr_download_examples_plot_madgwick.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_madgwick.py <plot_madgwick.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_madgwick.ipynb <plot_madgwick.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
