image: ubuntu:jammy

stages:
  - test
  - deploy
  - release

test:
  stage: test
  script:
    - export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
    - echo "tzdata tzdata/Areas select Europe" > preseed.txt && echo "tzdata tzdata/Zones/Europe select Paris" >> preseed.txt
    - debconf-set-selections preseed.txt
    - apt-get update --allow-releaseinfo-change && apt-get install -yqq --no-install-recommends graphviz python3-pip python3.10-dev python3.10-venv libblas-dev liblapack-dev cmake gfortran gcc g++ make libproj-dev proj-data proj-bin libgeos-dev curl
    - python3 --version
    - python3 -m venv sim
    - source sim/bin/activate
    - pip3 install hatch
    - SETUPTOOLS_SCM_PRETEND_VERSION=$CI_COMMIT_REF_NAME hatch build
    - SETUPTOOLS_SCM_PRETEND_VERSION=$CI_COMMIT_REF_NAME hatch run doc:build
    - SETUPTOOLS_SCM_PRETEND_VERSION=$CI_COMMIT_REF_NAME hatch run test:run
  artifacts:
    when: always
    paths:
      - build/htmldoc

# https://ydethe.gitlab.io/blocksim/htmldoc/blocksim/
pages:
  stage: deploy
  dependencies:
  - test
  script:
    - cp -r build/htmldoc public
  artifacts:
    paths:
      - public
