image: ubuntu:focal

stages:
  - test
  - deploy
  - release

test:
  stage: test
  script:
    - export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
    - echo "tzdata tzdata/Areas select Europe" > preseed.txt
    - echo "tzdata tzdata/Zones/Europe select Paris" >> preseed.txt
    - debconf-set-selections preseed.txt
    - apt-get update --allow-releaseinfo-change && apt-get install -yqq --no-install-recommends python3-pip python3.8-dev python3.8-venv libblas-dev liblapack-dev cmake gfortran gcc g++ make libproj-dev proj-data proj-bin libgeos-dev curl
    - python3 --version
    - pip3 install "numpy==1.22.3" "scikit-build==0.14.1"
    - pip3 install "cartopy<0.20.0" "slycot~=0.4.0.0"
    - pip3 install -r dev_requirements_3_8.txt
    - python3 setup.py develop
    - python3 -m pytest --mpl --mpl-generate-summary=html --mpl-baseline-path=tests/baseline --mpl-results-path=results --cov blocksim/ tests --doctest-modules blocksim/
    - sh mkdoc.sh
    - coverage html
    - python3 setup.py sdist
    - pip3 wheel --no-index --no-deps --wheel-dir dist dist/*.tar.gz
  artifacts:
    when: always
    paths:
      - results
      - htmlcov
      - htmldoc
      - dist

pages:
  stage: deploy
  dependencies:
  - test
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
      when: always
  script:
    - mkdir public
    - cp -r htmlcov htmldoc public
  artifacts:
    paths:
      - public
